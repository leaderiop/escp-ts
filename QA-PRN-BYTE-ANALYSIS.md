# ESC/P PRN Byte-Level QA Analysis Report

**Date:** 2025-11-27
**Analyst:** Senior ESC/P QA Engineer
**Focus:** PRN output byte sequences for layout system features
**Resolution:** 360 DPI

---

## Executive Summary

This report details byte-level analysis of PRN output files generated by the ESC/P TypeScript library's layout system. The analysis focuses on verifying that ESC/P positioning commands (ESC $, ESC J) produce correct byte sequences for flex, stack, grid, margins, padding, and gaps.

**Key Findings:**
- Most positioning calculations are mathematically correct
- ESC $ horizontal positioning has inherent rounding errors (quantized to 6-dot increments)
- One critical bug: Flex width constraint is being ignored
- Grid and stack gaps translate correctly to ESC/P commands

---

## ESC/P Command Reference

### Position Commands Analyzed

| Command | Bytes | Description | Formula |
|---------|-------|-------------|---------|
| ESC @ | 1B 40 | Initialize printer | Reset all |
| ESC $ nL nH | 1B 24 nL nH | Absolute horizontal position | X = (nL + nH*256) * 6 dots |
| ESC J n | 1B 4A n | Advance vertical position | Y += n * 2 dots |

### Unit Conversions at 360 DPI

- ESC $ units: 1/60 inch = 6 dots
- ESC J units: 1/180 inch = 2 dots
- Character width at 10 CPI: 36 dots
- Default line height: 60 dots (1/6 inch)

---

## Feature-by-Feature PRN Analysis

### 1. Flex Layout - justify: start, gap=0

**File:** `qa-prn-flex-01-no-gap.prn`
**Hex:** `1b40 4142 43`

```
Feature: Flex justify=start, gap=0
ESC/P Commands:
  - ESC @ (1B 40): Initialize
  - Text "ABC" printed at implicit position 0
Expected: No ESC $ commands needed (sequential printing)
Actual: No ESC $ commands present
Status: PASS
Notes: Correct optimization - consecutive items don't need positioning commands
```

---

### 2. Flex Layout - justify: start, gap=36

**File:** `qa-prn-flex-02-gap-36.prn`
**Hex:** `1b40 411b 240c 0042 1b24 1800 43`

```
Feature: Flex justify=start, gap=36 dots
ESC/P Commands:
  Offset 0x00: ESC @ (1B 40) - Initialize
  Offset 0x02: 'A' (41) at X=0
  Offset 0x03: ESC $ (1B 24 0C 00)
    nL=0x0C=12, nH=0x00
    Position = 12 * 6 = 72 dots
    Expected: 36 (char) + 36 (gap) = 72 dots
  Offset 0x07: 'B' (42) at X=72
  Offset 0x08: ESC $ (1B 24 18 00)
    nL=0x18=24, nH=0x00
    Position = 24 * 6 = 144 dots
    Expected: 72 + 36 + 36 = 144 dots
  Offset 0x0C: 'C' (43) at X=144
Status: PASS
Notes: Gap calculations translate correctly to ESC $ positions
```

---

### 3. Flex Layout - justify: end

**File:** `qa-prn-flex-03-justify-end.prn`
**Hex:** `1b40 1b24 ec01 4142 43`

```
Feature: Flex justify=end, gap=0
ESC/P Commands:
  Offset 0x00: ESC @ (1B 40) - Initialize
  Offset 0x02: ESC $ (1B 24 EC 01)
    nL=0xEC=236, nH=0x01=1
    Position = (236 + 256) * 6 = 492 * 6 = 2952 dots
    Expected: 3060 (page) - 108 (3 chars * 36) = 2952 dots
  Offset 0x06: "ABC" at X=2952
Status: PASS
Notes: End alignment correctly pushes content to right edge
```

---

### 4. Flex Layout - justify: center

**File:** `qa-prn-flex-04-justify-center.prn`
**Hex:** `1b40 1b24 f600 4142 43`

```
Feature: Flex justify=center, gap=0
ESC/P Commands:
  Offset 0x00: ESC @ (1B 40) - Initialize
  Offset 0x02: ESC $ (1B 24 F6 00)
    nL=0xF6=246, nH=0x00
    Position = 246 * 6 = 1476 dots
    Expected: (3060 - 108) / 2 = 1476 dots
  Offset 0x06: "ABC" at X=1476
Status: PASS
Notes: Center calculation is exact (no rounding error)
```

---

### 5. Flex Layout - justify: space-between

**File:** `qa-prn-flex-05-space-between.prn`
**Hex:** `1b40 411b 24fc 0042 1b24 f801 43`

```
Feature: Flex justify=space-between, gap=0
ESC/P Commands:
  Offset 0x00: ESC @ (1B 40) - Initialize
  Offset 0x02: 'A' at X=0 (implicit)
  Offset 0x03: ESC $ (1B 24 FC 00)
    Position = 252 * 6 = 1512 dots
    Expected: 0 + 36 + (3060-108)/2 = 36 + 1476 = 1512 dots
  Offset 0x07: 'B' at X=1512
  Offset 0x08: ESC $ (1B 24 F8 01)
    Position = (248 + 256) * 6 = 3024 dots
    Expected: 3060 - 36 = 3024 dots
  Offset 0x0C: 'C' at X=3024
Status: PASS
Notes: Space distribution is mathematically correct
```

---

### 6. Flex Layout - Width Constraint Bug (CRITICAL)

**File:** `qa-prn-flex-06-width-constraint.prn`
**Hex:** `1b40 411b 24fc 0042 1b24 f801 43`

```
Feature: Flex width=500, justify=space-between
ESC/P Commands:
  Offset 0x00: ESC @ (1B 40) - Initialize
  Offset 0x02: 'A' at X=0
  Offset 0x03: ESC $ (1B 24 FC 00) -> 1512 dots
  Offset 0x07: 'B' at X=1512
  Offset 0x08: ESC $ (1B 24 F8 01) -> 3024 dots
  Offset 0x0C: 'C' at X=3024

Expected (500-dot container):
  Space = (500 - 108) / 2 = 196 dots
  A=0, B=232, C=464

Actual:
  A=0, B=1512, C=3024 (using full page width 3060)

Status: FAIL - CRITICAL BUG
Bug ID: PRN-BUG-001
Impact: Flex containers ignore explicit width constraint for justify calculations
Root Cause: layoutFlexNode() uses ctx.width instead of measured.preferredWidth
            when explicit width is specified
```

---

### 7. Stack Layout - Vertical Gap

**File:** `qa-prn-stack-02-gap-60.prn`
**Hex:** `1b40 4c69 6e65 311b 4a3c 1b24 0000 4c69 6e65 321b 4a3c 1b24 0000 4c69 6e65 33`

```
Feature: Stack direction=column, gap=60 dots
ESC/P Commands:
  Offset 0x00: ESC @ (1B 40) - Initialize
  Offset 0x02: "Line1" at (0, 0)
  Offset 0x07: ESC J (1B 4A 3C)
    n=0x3C=60 units, advance = 60 * 2 = 120 dots
    Expected: 60 (line height) + 60 (gap) = 120 dots
  Offset 0x0A: ESC $ (1B 24 00 00) -> X=0
  Offset 0x0E: "Line2" at (0, 120)
  Offset 0x13: ESC J (1B 4A 3C) -> Y+=120 dots
  Offset 0x16: ESC $ (1B 24 00 00) -> X=0
  Offset 0x1A: "Line3" at (0, 240)
Status: PASS
Notes: Vertical gap correctly adds to line height in ESC J parameter
```

---

### 8. Grid Layout - Multi-Row with Gaps

**File:** `qa-prn-grid-03-multi-row.prn`
**Hex:** `1b40 5231 1b24 1400 5231 1b24 2800 5231 1b4a 2d1b 2400 0052 321b 2414 0052 321b 2428 0052 32`

```
Feature: Grid [100,100,100], columnGap=20, rowGap=30
ESC/P Commands:
  Row 1:
    Offset 0x02: "R1" at X=0 (implicit)
    Offset 0x04: ESC $ (1B 24 14 00) -> 20*6=120 dots (column 1: 100+20)
    Offset 0x08: "R1" at X=120
    Offset 0x0A: ESC $ (1B 24 28 00) -> 40*6=240 dots (column 2: 100+20+100+20)
    Offset 0x0E: "R1" at X=240

  Row Advance:
    Offset 0x10: ESC J (1B 4A 2D) -> 45*2=90 dots (60 height + 30 gap)

  Row 2:
    Offset 0x13: ESC $ (1B 24 00 00) -> X=0
    Offset 0x17: "R2" at X=0
    Offset 0x19: ESC $ (1B 24 14 00) -> X=120
    Offset 0x1D: "R2" at X=120
    Offset 0x1F: ESC $ (1B 24 28 00) -> X=240
    Offset 0x23: "R2" at X=240

Expected Column Positions: 0, 120, 240
Actual Column Positions: 0, 120, 240
Expected Row Y Positions: 0, 90
Actual Row Y Positions: 0, 90
Status: PASS
Notes: Grid column and row gap calculations are correct
```

---

### 9. Margin Left - Rounding Anomaly

**File:** `qa-prn-margin-02-left.prn`
**Hex:** `1b40 1b24 0800 4c65 6674 4d61 7267 696e`

```
Feature: Left margin = 50 dots
ESC/P Commands:
  Offset 0x00: ESC @ (1B 40) - Initialize
  Offset 0x02: ESC $ (1B 24 08 00)
    nL=0x08=8, nH=0x00
    Position = 8 * 6 = 48 dots
    Expected: 50 dots
  Offset 0x06: "LeftMargin" at X=48

Status: WARNING - Rounding Error
Bug ID: PRN-WARN-001
Impact: 2-dot position error (50 vs 48)
Root Cause: ESC $ uses 1/60 inch units (6-dot granularity)
            50 / 6 = 8.33 -> rounds to 8 -> 8 * 6 = 48
Notes: This is an inherent limitation of the ESC $ command's resolution.
       Positions not divisible by 6 will have up to 3-dot error.
```

---

### 10. Absolute Positioning - X Position Rounding

**File:** `qa-prn-abs-04-xy.prn`
**Hex:** `1b40 1b4a 4b1b 2421 0048 4552 45`

```
Feature: Absolute position at (200, 150)
ESC/P Commands:
  Offset 0x00: ESC @ (1B 40) - Initialize
  Offset 0x02: ESC J (1B 4A 4B)
    n=0x4B=75 units, advance = 75 * 2 = 150 dots
    Expected Y: 150 dots - CORRECT
  Offset 0x05: ESC $ (1B 24 21 00)
    nL=0x21=33, nH=0x00
    Position = 33 * 6 = 198 dots
    Expected X: 200 dots - ERROR: 2 dot difference
  Offset 0x09: "HERE" at (198, 150)

Status: WARNING - X Position Rounding
Bug ID: PRN-WARN-002
Impact: 2-dot horizontal position error (200 vs 198)
Root Cause: 200 / 6 = 33.33 -> rounds to 33 -> 33 * 6 = 198
Notes: Same inherent ESC $ resolution limitation
```

---

## Summary of Anomalies

### Critical Bugs

| Bug ID | Feature | Expected | Actual | Impact |
|--------|---------|----------|--------|--------|
| PRN-BUG-001 | Flex width constraint | B=232 | B=1512 | Width constraint ignored |

### Warnings (Inherent Limitations)

| Warning ID | Feature | Expected | Actual | Impact |
|------------|---------|----------|--------|--------|
| PRN-WARN-001 | Left margin 50 | 50 dots | 48 dots | 2-dot error |
| PRN-WARN-002 | Abs X position 200 | 200 dots | 198 dots | 2-dot error |

### Features Passing

| Feature | Test File | Status |
|---------|-----------|--------|
| Flex justify=start, gap=0 | qa-prn-flex-01-no-gap.prn | PASS |
| Flex justify=start, gap=36 | qa-prn-flex-02-gap-36.prn | PASS |
| Flex justify=end | qa-prn-flex-03-justify-end.prn | PASS |
| Flex justify=center | qa-prn-flex-04-justify-center.prn | PASS |
| Flex justify=space-between | qa-prn-flex-05-space-between.prn | PASS |
| Stack gap=60 | qa-prn-stack-02-gap-60.prn | PASS |
| Grid columnGap+rowGap | qa-prn-grid-03-multi-row.prn | PASS |
| Padding=30 | qa-prn-margin-04-padding.prn | PASS |
| Top margin=100 | qa-prn-margin-03-top.prn | PASS |

---

## Root Cause Analysis

### PRN-BUG-001: Flex Width Constraint Ignored

**Location:** `/Users/mohammadalmechkor/Projects/escp-ts/src/layout/layout.ts`

**Problem:** In `layoutFlexNode()`, the justify position calculations use `ctx.width` (available width from parent) instead of considering the flex container's own explicit width.

**Evidence:**
```typescript
// Line 387-388 in layout.ts:
const contentWidth = ctx.width - margin.left - margin.right - padding.left - padding.right;
```

When a flex container has `width=500`, the `ctx.width` from the parent is still the full page width. The explicit width is stored in `measured.preferredWidth` but not used for content distribution.

**Recommended Fix:**
```typescript
// Should use measured.preferredWidth when explicit width is set:
const baseWidth = measured.explicitWidth ?? ctx.width;
const contentWidth = baseWidth - margin.left - margin.right - padding.left - padding.right;
```

---

### PRN-WARN-001/002: ESC $ Position Rounding

**Root Cause:** The ESC $ command operates in 1/60 inch units (6 dots at 360 DPI). Any position not divisible by 6 will be rounded.

**Impact Table:**
| Requested | Nearest Unit | Actual | Error |
|-----------|-------------|--------|-------|
| 50 dots | 8 (48) | 48 | -2 |
| 100 dots | 17 (102) | 102 | +2 |
| 200 dots | 33 (198) | 198 | -2 |

**Mitigation:** This is an inherent hardware limitation. Consider:
1. Documenting this limitation for users
2. Using positions divisible by 6 for pixel-perfect alignment
3. Investigating ESC ( U command for finer unit control (ESC/P2 only)

---

## Conclusion

The ESC/P TypeScript library produces correct byte sequences for the majority of layout operations. The critical bug (PRN-BUG-001) where flex containers ignore explicit width constraints needs immediate attention as it affects real-world use cases like fixed-width invoice layouts.

The position rounding warnings are inherent ESC $ limitations and cannot be fixed at the library level, but should be documented for users who require sub-6-dot positioning precision.

**Quality Rating:** 8/10 - One critical bug, but otherwise solid byte-level output
