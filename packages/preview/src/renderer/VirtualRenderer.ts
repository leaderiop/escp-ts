/**
 * Virtual Renderer
 * Renders ESC/P2 output to a bitmap for preview purposes
 * This creates an in-memory representation of what would be printed
 */

import {
  ASCII,
  ESC_COMMANDS,
  createInitialState,
  calculateLineHeight,
  getPageHeight,
  getProportionalWidth,
  GRAPHICS_MODES,
  type PrinterState,
  type PaperConfig,
  type BitImageMode,
} from '@escp/core';

/**
 * Virtual page bitmap
 */
export interface VirtualPage {
  /** Page number (0-indexed) */
  number: number;
  /** Page width in pixels */
  width: number;
  /** Page height in pixels */
  height: number;
  /** Bitmap data (1 byte per pixel, 0=white, 255=black) */
  data: Uint8Array;
}

/**
 * Render options
 */
export interface VirtualRenderOptions {
  /** Horizontal DPI (default: 360) */
  horizontalDpi: number;
  /** Vertical DPI (default: 360) */
  verticalDpi: number;
  /** Scale factor for output (default: 1) */
  scale: number;
  /** Show margins as gray lines (default: false) */
  showMargins: boolean;
  /** Margin line color (0-255) */
  marginColor: number;
}

/**
 * Default render options
 */
export const DEFAULT_RENDER_OPTIONS: VirtualRenderOptions = {
  horizontalDpi: 360,
  verticalDpi: 360,
  scale: 1,
  showMargins: false,
  marginColor: 200,
};

/**
 * Simple 8x16 bitmap font for rendering text
 * Each character is 8 pixels wide, 16 pixels tall
 * This is a minimal ASCII font for preview purposes
 */
const BITMAP_FONT: Record<number, number[]> = {
  // Space
  32: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  // !
  33: [
    0x00, 0x00, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00,
  ],
  // "
  34: [
    0x00, 0x00, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  // 0-9
  48: [
    0x00, 0x00, 0x3c, 0x66, 0x66, 0x6e, 0x76, 0x66, 0x66, 0x66, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  49: [
    0x00, 0x00, 0x18, 0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  50: [
    0x00, 0x00, 0x3c, 0x66, 0x06, 0x0c, 0x18, 0x30, 0x60, 0x66, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  51: [
    0x00, 0x00, 0x3c, 0x66, 0x06, 0x1c, 0x06, 0x06, 0x06, 0x66, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  52: [
    0x00, 0x00, 0x0c, 0x1c, 0x3c, 0x6c, 0xcc, 0xfe, 0x0c, 0x0c, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  53: [
    0x00, 0x00, 0x7e, 0x60, 0x60, 0x7c, 0x06, 0x06, 0x06, 0x66, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  54: [
    0x00, 0x00, 0x1c, 0x30, 0x60, 0x7c, 0x66, 0x66, 0x66, 0x66, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  55: [
    0x00, 0x00, 0x7e, 0x66, 0x06, 0x0c, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  56: [
    0x00, 0x00, 0x3c, 0x66, 0x66, 0x3c, 0x66, 0x66, 0x66, 0x66, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  57: [
    0x00, 0x00, 0x3c, 0x66, 0x66, 0x66, 0x3e, 0x06, 0x06, 0x0c, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  // A-Z (uppercase)
  65: [
    0x00, 0x00, 0x18, 0x3c, 0x66, 0x66, 0x7e, 0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  66: [
    0x00, 0x00, 0x7c, 0x66, 0x66, 0x7c, 0x66, 0x66, 0x66, 0x66, 0x7c, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  67: [
    0x00, 0x00, 0x3c, 0x66, 0x60, 0x60, 0x60, 0x60, 0x60, 0x66, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  68: [
    0x00, 0x00, 0x78, 0x6c, 0x66, 0x66, 0x66, 0x66, 0x66, 0x6c, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  69: [
    0x00, 0x00, 0x7e, 0x60, 0x60, 0x7c, 0x60, 0x60, 0x60, 0x60, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  70: [
    0x00, 0x00, 0x7e, 0x60, 0x60, 0x7c, 0x60, 0x60, 0x60, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  71: [
    0x00, 0x00, 0x3c, 0x66, 0x60, 0x60, 0x6e, 0x66, 0x66, 0x66, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  72: [
    0x00, 0x00, 0x66, 0x66, 0x66, 0x7e, 0x66, 0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  73: [
    0x00, 0x00, 0x7e, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  74: [
    0x00, 0x00, 0x3e, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x6c, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  75: [
    0x00, 0x00, 0x66, 0x6c, 0x78, 0x70, 0x78, 0x6c, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  76: [
    0x00, 0x00, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  77: [
    0x00, 0x00, 0x63, 0x77, 0x7f, 0x6b, 0x63, 0x63, 0x63, 0x63, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  78: [
    0x00, 0x00, 0x66, 0x66, 0x76, 0x7e, 0x6e, 0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  79: [
    0x00, 0x00, 0x3c, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  80: [
    0x00, 0x00, 0x7c, 0x66, 0x66, 0x7c, 0x60, 0x60, 0x60, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  81: [
    0x00, 0x00, 0x3c, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x6c, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  82: [
    0x00, 0x00, 0x7c, 0x66, 0x66, 0x7c, 0x6c, 0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  83: [
    0x00, 0x00, 0x3c, 0x66, 0x60, 0x30, 0x18, 0x0c, 0x06, 0x66, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  84: [
    0x00, 0x00, 0x7e, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  85: [
    0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  86: [
    0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3c, 0x3c, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  87: [
    0x00, 0x00, 0x63, 0x63, 0x63, 0x63, 0x6b, 0x7f, 0x77, 0x63, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  88: [
    0x00, 0x00, 0x66, 0x66, 0x3c, 0x18, 0x18, 0x3c, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  89: [
    0x00, 0x00, 0x66, 0x66, 0x66, 0x3c, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  90: [
    0x00, 0x00, 0x7e, 0x06, 0x0c, 0x18, 0x18, 0x30, 0x60, 0x60, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  // a-z (lowercase)
  97: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x3c, 0x06, 0x3e, 0x66, 0x66, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  98: [
    0x00, 0x00, 0x60, 0x60, 0x60, 0x7c, 0x66, 0x66, 0x66, 0x66, 0x7c, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  99: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x3c, 0x66, 0x60, 0x60, 0x66, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  100: [
    0x00, 0x00, 0x06, 0x06, 0x06, 0x3e, 0x66, 0x66, 0x66, 0x66, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  101: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x3c, 0x66, 0x7e, 0x60, 0x66, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  102: [
    0x00, 0x00, 0x1c, 0x36, 0x30, 0x7c, 0x30, 0x30, 0x30, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  103: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x66, 0x66, 0x66, 0x3e, 0x06, 0x66, 0x3c, 0x00, 0x00, 0x00,
  ],
  104: [
    0x00, 0x00, 0x60, 0x60, 0x60, 0x7c, 0x66, 0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  105: [
    0x00, 0x00, 0x18, 0x18, 0x00, 0x38, 0x18, 0x18, 0x18, 0x18, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  106: [
    0x00, 0x00, 0x0c, 0x0c, 0x00, 0x1c, 0x0c, 0x0c, 0x0c, 0x0c, 0x6c, 0x6c, 0x38, 0x00, 0x00, 0x00,
  ],
  107: [
    0x00, 0x00, 0x60, 0x60, 0x60, 0x66, 0x6c, 0x78, 0x6c, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  108: [
    0x00, 0x00, 0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  109: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x7f, 0x6b, 0x6b, 0x6b, 0x63, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  110: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x7c, 0x66, 0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  111: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x3c, 0x66, 0x66, 0x66, 0x66, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  112: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x7c, 0x66, 0x66, 0x66, 0x7c, 0x60, 0x60, 0x60, 0x00, 0x00, 0x00,
  ],
  113: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x66, 0x66, 0x66, 0x3e, 0x06, 0x06, 0x06, 0x00, 0x00, 0x00,
  ],
  114: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x6c, 0x76, 0x60, 0x60, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  115: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x60, 0x3c, 0x06, 0x06, 0x7c, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  116: [
    0x00, 0x00, 0x30, 0x30, 0x30, 0x7c, 0x30, 0x30, 0x30, 0x36, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  117: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  118: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x3c, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  119: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x63, 0x6b, 0x6b, 0x7f, 0x36, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  120: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x3c, 0x18, 0x3c, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  121: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x3e, 0x06, 0x66, 0x3c, 0x00, 0x00, 0x00,
  ],
  122: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x7e, 0x0c, 0x18, 0x30, 0x60, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00,
  ],
  // Punctuation and symbols
  35: [
    0x00, 0x00, 0x24, 0x24, 0x7e, 0x24, 0x24, 0x7e, 0x24, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // #
  36: [
    0x00, 0x00, 0x18, 0x3e, 0x60, 0x3c, 0x06, 0x7c, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // $
  37: [
    0x00, 0x00, 0x62, 0x64, 0x08, 0x10, 0x20, 0x4c, 0x8c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // %
  38: [
    0x00, 0x00, 0x30, 0x48, 0x48, 0x30, 0x4a, 0x44, 0x44, 0x3a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // &
  39: [
    0x00, 0x00, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // '
  40: [
    0x00, 0x00, 0x0c, 0x18, 0x30, 0x30, 0x30, 0x30, 0x30, 0x18, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // (
  41: [
    0x00, 0x00, 0x30, 0x18, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // )
  42: [
    0x00, 0x00, 0x00, 0x00, 0x24, 0x18, 0x7e, 0x18, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // *
  43: [
    0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x7e, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // +
  44: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x18, 0x30, 0x00, 0x00, 0x00,
  ], // ,
  45: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // -
  46: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00,
  ], // .
  47: [
    0x00, 0x00, 0x02, 0x06, 0x0c, 0x18, 0x30, 0x60, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // /
  58: [
    0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // :
  59: [
    0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x18, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00,
  ], // ;
  60: [
    0x00, 0x00, 0x06, 0x0c, 0x18, 0x30, 0x60, 0x30, 0x18, 0x0c, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // <
  61: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x7e, 0x00, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // =
  62: [
    0x00, 0x00, 0x60, 0x30, 0x18, 0x0c, 0x06, 0x0c, 0x18, 0x30, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // >
  63: [
    0x00, 0x00, 0x3c, 0x66, 0x06, 0x0c, 0x18, 0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // ?
  64: [
    0x00, 0x00, 0x3c, 0x66, 0x6e, 0x6a, 0x6e, 0x60, 0x60, 0x66, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // @
  91: [
    0x00, 0x00, 0x3c, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // [
  92: [
    0x00, 0x00, 0x80, 0xc0, 0x60, 0x30, 0x18, 0x0c, 0x06, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // \
  93: [
    0x00, 0x00, 0x3c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // ]
  94: [
    0x00, 0x00, 0x18, 0x3c, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // ^
  95: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7e, 0x00, 0x00, 0x00,
  ], // _
  96: [
    0x00, 0x00, 0x30, 0x18, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // `
  123: [
    0x00, 0x00, 0x0e, 0x18, 0x18, 0x18, 0x70, 0x18, 0x18, 0x18, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // {
  124: [
    0x00, 0x00, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // |
  125: [
    0x00, 0x00, 0x70, 0x18, 0x18, 0x18, 0x0e, 0x18, 0x18, 0x18, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // }
  126: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x32, 0x4c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // ~

  // CP437 Box-drawing characters (0xB3-0xDA range)
  // Single line characters - centered for proper connection (using 0x18 = 00011000 for center column)
  0xb3: [
    0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18,
  ], // │ vertical line
  0xb4: [
    0x18, 0x18, 0x18, 0x18, 0x18, 0xf8, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18,
  ], // ┤ vertical with left junction
  0xbf: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18,
  ], // ┐ top-right corner
  0xc0: [
    0x18, 0x18, 0x18, 0x18, 0x18, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // └ bottom-left corner
  0xc1: [
    0x18, 0x18, 0x18, 0x18, 0x18, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // ┴ bottom T
  0xc2: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18,
  ], // ┬ top T
  0xc3: [
    0x18, 0x18, 0x18, 0x18, 0x18, 0x1f, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18,
  ], // ├ vertical with right junction
  0xc4: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // ─ horizontal line
  0xc5: [
    0x18, 0x18, 0x18, 0x18, 0x18, 0xff, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18,
  ], // ┼ cross
  0xd9: [
    0x18, 0x18, 0x18, 0x18, 0x18, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // ┘ bottom-right corner
  0xda: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18,
  ], // ┌ top-left corner

  // Double line characters - using 0x36 (00110110) for double vertical columns at positions 1,2 and 5,6
  0xba: [
    0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  ], // ║ double vertical
  0xbb: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0xf6, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  ], // ╗ double top-right
  0xbc: [
    0x36, 0x36, 0x36, 0x36, 0x36, 0xf6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // ╝ double bottom-right
  0xb9: [
    0x36, 0x36, 0x36, 0x36, 0x36, 0xf6, 0x06, 0xf6, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  ], // ╣ double right T
  0xc8: [
    0x36, 0x36, 0x36, 0x36, 0x36, 0x37, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // ╚ double bottom-left
  0xc9: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x37, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  ], // ╔ double top-left
  0xca: [
    0x36, 0x36, 0x36, 0x36, 0x36, 0xf7, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // ╩ double bottom T
  0xcb: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0xf7, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  ], // ╦ double top T
  0xcc: [
    0x36, 0x36, 0x36, 0x36, 0x36, 0x37, 0x30, 0x37, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  ], // ╠ double left T
  0xcd: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // ═ double horizontal
  0xce: [
    0x36, 0x36, 0x36, 0x36, 0x36, 0xf7, 0x00, 0xf7, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  ], // ╬ double cross

  // Mixed single/double connectors (simplified versions)
  0xb5: [
    0x18, 0x18, 0x18, 0x18, 0x18, 0xfe, 0x00, 0xfe, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18,
  ], // ╡ single-vert double-horiz right
  0xb6: [
    0x36, 0x36, 0x36, 0x36, 0x36, 0xf8, 0x18, 0xf8, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  ], // ╢ double-vert single-horiz right
  0xb7: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x06, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  ], // ╖ single-horiz double-vert top-right
  0xb8: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0xf8, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18,
  ], // ╕ double-horiz single-vert top-right
  0xbe: [
    0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x06, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // ╛ single-horiz double-vert bottom-right
  0xbd: [
    0x18, 0x18, 0x18, 0x18, 0x18, 0x1f, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // ╜ double-horiz single-vert bottom-right
  0xc6: [
    0x18, 0x18, 0x18, 0x18, 0x18, 0x1f, 0x00, 0x1f, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18,
  ], // ╞ single-vert double-horiz left
  0xc7: [
    0x36, 0x36, 0x36, 0x36, 0x36, 0x37, 0x30, 0x37, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  ], // ╟ double-vert single-horiz left
  0xcf: [
    0x18, 0x18, 0x18, 0x18, 0x18, 0xff, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // ╧ single-vert double-horiz bottom
  0xd0: [
    0x36, 0x36, 0x36, 0x36, 0x36, 0xff, 0x18, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // ╨ double-vert single-horiz bottom
  0xd1: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0xff, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18,
  ], // ╤ single-vert double-horiz top
  0xd2: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x18, 0xff, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  ], // ╥ double-vert single-horiz top
  0xd3: [
    0x36, 0x36, 0x36, 0x36, 0x36, 0x37, 0x18, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // ╙ double-vert single-horiz bottom-left
  0xd4: [
    0x18, 0x18, 0x18, 0x18, 0x18, 0x1f, 0x00, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // ╘ single-vert double-horiz bottom-left
  0xd5: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x1f, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18,
  ], // ╒ single-vert double-horiz top-left
  0xd6: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x18, 0x37, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  ], // ╓ double-vert single-horiz top-left
  0xd7: [
    0x36, 0x36, 0x36, 0x36, 0x36, 0xff, 0x18, 0xff, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  ], // ╫ double-vert single-horiz cross
  0xd8: [
    0x18, 0x18, 0x18, 0x18, 0x18, 0xff, 0x00, 0xff, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18,
  ], // ╪ single-vert double-horiz cross

  // Unicode Box Drawing Characters (U+2500 range) - same glyphs as CP437 equivalents
  // Single line (light)
  0x2500: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // ─ horizontal
  0x2502: [
    0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18,
  ], // │ vertical
  0x250c: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18,
  ], // ┌ top-left
  0x2510: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18,
  ], // ┐ top-right
  0x2514: [
    0x18, 0x18, 0x18, 0x18, 0x18, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // └ bottom-left
  0x2518: [
    0x18, 0x18, 0x18, 0x18, 0x18, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // ┘ bottom-right
  0x251c: [
    0x18, 0x18, 0x18, 0x18, 0x18, 0x1f, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18,
  ], // ├ left T
  0x2524: [
    0x18, 0x18, 0x18, 0x18, 0x18, 0xf8, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18,
  ], // ┤ right T
  0x252c: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18,
  ], // ┬ top T
  0x2534: [
    0x18, 0x18, 0x18, 0x18, 0x18, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // ┴ bottom T
  0x253c: [
    0x18, 0x18, 0x18, 0x18, 0x18, 0xff, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18,
  ], // ┼ cross

  // Double line
  0x2550: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // ═ double horizontal
  0x2551: [
    0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  ], // ║ double vertical
  0x2554: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x37, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  ], // ╔ double top-left
  0x2557: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0xf6, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  ], // ╗ double top-right
  0x255a: [
    0x36, 0x36, 0x36, 0x36, 0x36, 0x37, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // ╚ double bottom-left
  0x255d: [
    0x36, 0x36, 0x36, 0x36, 0x36, 0xf6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // ╝ double bottom-right
  0x2560: [
    0x36, 0x36, 0x36, 0x36, 0x36, 0x37, 0x30, 0x37, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  ], // ╠ double left T
  0x2563: [
    0x36, 0x36, 0x36, 0x36, 0x36, 0xf6, 0x06, 0xf6, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  ], // ╣ double right T
  0x2566: [
    0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0xf7, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  ], // ╦ double top T
  0x2569: [
    0x36, 0x36, 0x36, 0x36, 0x36, 0xf7, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  ], // ╩ double bottom T
  0x256c: [
    0x36, 0x36, 0x36, 0x36, 0x36, 0xf7, 0x00, 0xf7, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36, 0x36,
  ], // ╬ double cross
};

// Fill missing characters with a box
for (let i = 33; i < 127; i++) {
  if (!(i in BITMAP_FONT)) {
    BITMAP_FONT[i] = [
      0x00, 0x00, 0x7e, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x7e, 0x00, 0x00, 0x00, 0x00,
      0x00,
    ];
  }
}

/**
 * Virtual Renderer class
 * Parses ESC/P2 commands and renders to a bitmap
 */
export class VirtualRenderer {
  private state: PrinterState;
  private options: VirtualRenderOptions;
  private pages: VirtualPage[] = [];
  private currentPage: VirtualPage | null = null;

  constructor(paper: Partial<PaperConfig> = {}, options: Partial<VirtualRenderOptions> = {}) {
    this.options = { ...DEFAULT_RENDER_OPTIONS, ...options };
    this.state = createInitialState(paper);
    this.initNewPage();
  }

  /**
   * Initialize a new page
   */
  private initNewPage(): void {
    const width = Math.round(
      this.state.paper.widthInches * this.options.horizontalDpi * this.options.scale
    );
    const height = Math.round(
      this.state.paper.heightInches * this.options.verticalDpi * this.options.scale
    );

    this.currentPage = {
      number: this.pages.length,
      width,
      height,
      data: new Uint8Array(width * height).fill(0), // White background
    };

    // Draw margins if enabled
    if (this.options.showMargins) {
      this.drawMargins();
    }
  }

  /**
   * Draw margin lines on current page
   */
  private drawMargins(): void {
    if (!this.currentPage) return;

    const { width, height, data } = this.currentPage;
    const color = this.options.marginColor;

    // Convert margin dots to pixels
    const leftPx = Math.round(
      (this.state.paper.margins.left / 360) * this.options.horizontalDpi * this.options.scale
    );
    const rightPx =
      width -
      Math.round(
        (this.state.paper.margins.right / 360) * this.options.horizontalDpi * this.options.scale
      );
    const topPx = Math.round(
      (this.state.paper.margins.top / 360) * this.options.verticalDpi * this.options.scale
    );
    const bottomPx =
      height -
      Math.round(
        (this.state.paper.margins.bottom / 360) * this.options.verticalDpi * this.options.scale
      );

    // Draw horizontal lines
    for (let x = 0; x < width; x++) {
      if (topPx >= 0 && topPx < height) data[topPx * width + x] = color;
      if (bottomPx >= 0 && bottomPx < height) data[bottomPx * width + x] = color;
    }

    // Draw vertical lines
    for (let y = 0; y < height; y++) {
      if (leftPx >= 0 && leftPx < width) data[y * width + leftPx] = color;
      if (rightPx >= 0 && rightPx < width) data[y * width + rightPx] = color;
    }
  }

  /**
   * Convert dot position to pixel position
   */
  private dotToPixel(dotX: number, dotY: number): { x: number; y: number } {
    return {
      x: Math.round((dotX / 360) * this.options.horizontalDpi * this.options.scale),
      y: Math.round((dotY / 360) * this.options.verticalDpi * this.options.scale),
    };
  }

  /**
   * Set a pixel on the current page
   */
  private setPixel(x: number, y: number, value = 255): void {
    if (!this.currentPage) return;
    const { width, height, data } = this.currentPage;

    if (x >= 0 && x < width && y >= 0 && y < height) {
      data[y * width + x] = value;
    }
  }

  /**
   * Draw a character at the given position
   */
  private drawChar(charCode: number, dotX: number, dotY: number): number {
    const fontData = BITMAP_FONT[charCode] ?? BITMAP_FONT[32]; // Default to space
    const { x: px, y: py } = this.dotToPixel(dotX, dotY);

    // Calculate character dimensions based on font settings
    const charWidthDots = this.state.font.style.proportional
      ? getProportionalWidth(charCode)
      : Math.round(360 / this.state.font.cpi);

    const scaleX = ((charWidthDots / 360) * this.options.horizontalDpi * this.options.scale) / 8;
    const scaleY =
      ((this.state.lineSpacing / 360) * this.options.verticalDpi * this.options.scale) / 16;

    if (!fontData) return charWidthDots;

    // Draw the character bitmap
    for (let row = 0; row < 16; row++) {
      const rowData = fontData[row] ?? 0;
      for (let col = 0; col < 8; col++) {
        if ((rowData >> (7 - col)) & 1) {
          // Calculate scaled position
          const startX = Math.round(px + col * scaleX);
          const endX = Math.round(px + (col + 1) * scaleX);
          const startY = Math.round(py + row * scaleY);
          const endY = Math.round(py + (row + 1) * scaleY);

          // Fill scaled pixel block
          for (let y = startY; y < endY; y++) {
            for (let x = startX; x < endX; x++) {
              this.setPixel(x, y, 255);
            }
          }
        }
      }
    }

    // Apply bold by drawing again with offset
    if (this.state.font.style.bold) {
      for (let row = 0; row < 16; row++) {
        const rowData = fontData[row] ?? 0;
        for (let col = 0; col < 8; col++) {
          if ((rowData >> (7 - col)) & 1) {
            const startX = Math.round(px + col * scaleX) + 1;
            const endX = Math.round(px + (col + 1) * scaleX) + 1;
            const startY = Math.round(py + row * scaleY);
            const endY = Math.round(py + (row + 1) * scaleY);

            for (let y = startY; y < endY; y++) {
              for (let x = startX; x < endX; x++) {
                this.setPixel(x, y, 255);
              }
            }
          }
        }
      }
    }

    // Draw underline if enabled
    if (this.state.font.style.underline) {
      const underlineY = py + Math.round(14 * scaleY);
      const charWidthPx = Math.round(
        charWidthDots * (this.options.horizontalDpi / 360) * this.options.scale
      );
      for (let x = px; x < px + charWidthPx; x++) {
        this.setPixel(x, underlineY, 255);
      }
    }

    return charWidthDots + this.state.interCharSpace;
  }

  /**
   * Render text at current position
   */
  renderText(text: string): void {
    for (const char of text) {
      const charCode = char.charCodeAt(0);
      const width = this.drawChar(charCode, this.state.x, this.state.y);
      this.state.x += width;
    }
  }

  /**
   * Carriage return
   */
  carriageReturn(): void {
    this.state.x = this.state.paper.margins.left;
  }

  /**
   * Line feed
   */
  lineFeed(): void {
    const lineHeight = calculateLineHeight(
      this.state.lineSpacing,
      this.state.font.style.doubleHeight
    );
    this.state.y += lineHeight;

    // Check for page break
    const maxY = getPageHeight(this.state.paper) - this.state.paper.margins.bottom;
    if (this.state.y >= maxY) {
      this.formFeed();
    }
  }

  /**
   * Form feed (new page)
   */
  formFeed(): void {
    if (this.currentPage) {
      this.pages.push(this.currentPage);
    }
    this.state.x = this.state.paper.margins.left;
    this.state.y = this.state.paper.margins.top;
    this.initNewPage();
  }

  /**
   * Render graphics data
   */
  renderGraphics(mode: BitImageMode, width: number, data: Uint8Array): void {
    const modeInfo = GRAPHICS_MODES[mode];
    if (!modeInfo) return;

    const bytesPerColumn = modeInfo.bytesPerColumn;

    let dataIdx = 0;
    for (let col = 0; col < width && dataIdx < data.length; col++) {
      for (let byteNum = 0; byteNum < bytesPerColumn && dataIdx < data.length; byteNum++) {
        const byte = data[dataIdx++] ?? 0;
        for (let bit = 0; bit < 8; bit++) {
          if ((byte >> (7 - bit)) & 1) {
            const pinY = byteNum * 8 + bit;
            const dotX = this.state.x + col;
            const dotY = this.state.y + pinY * 2; // 24-pin spacing

            const { x: px, y: py } = this.dotToPixel(dotX, dotY);
            this.setPixel(px, py, 255);
          }
        }
      }
    }

    this.state.x += width;
  }

  /**
   * Parse and render ESC/P2 command stream
   */
  render(data: Uint8Array): void {
    let i = 0;

    while (i < data.length) {
      const byte = data[i];
      if (byte === undefined) break;

      if (byte === ASCII.ESC && i + 1 < data.length) {
        const cmd = data[i + 1];
        i += 2;

        switch (cmd) {
          case ESC_COMMANDS.INITIALIZE: // ESC @
            this.state = createInitialState(this.state.paper);
            break;

          case ESC_COMMANDS.LINE_SPACING_1_6: // ESC 2
            this.state.lineSpacing = 60;
            break;

          case ESC_COMMANDS.LINE_SPACING_1_8: // ESC 0
            this.state.lineSpacing = 45;
            break;

          case ESC_COMMANDS.LINE_SPACING_N_180: // ESC 3 n
            if (i < data.length) {
              const n = data[i++] ?? 0;
              this.state.lineSpacing = Math.round((n / 180) * 360);
            }
            break;

          case ESC_COMMANDS.LINE_SPACING_N_360: // ESC + n
            if (i < data.length) {
              const n = data[i++] ?? 0;
              this.state.lineSpacing = n;
            }
            break;

          case ESC_COMMANDS.BOLD_ON: // ESC E
            this.state.font.style.bold = true;
            break;

          case ESC_COMMANDS.BOLD_OFF: // ESC F
            this.state.font.style.bold = false;
            break;

          case ESC_COMMANDS.ITALIC_ON: // ESC 4
            this.state.font.style.italic = true;
            break;

          case ESC_COMMANDS.ITALIC_OFF: // ESC 5
            this.state.font.style.italic = false;
            break;

          case ESC_COMMANDS.UNDERLINE: // ESC - n
            if (i < data.length) {
              const n = data[i++] ?? 0;
              this.state.font.style.underline = n !== 0;
            }
            break;

          case ESC_COMMANDS.DOUBLE_WIDTH: // ESC W n
            if (i < data.length) {
              const n = data[i++] ?? 0;
              this.state.font.style.doubleWidth = n !== 0;
            }
            break;

          case ESC_COMMANDS.DOUBLE_HEIGHT: // ESC w n
            if (i < data.length) {
              const n = data[i++] ?? 0;
              this.state.font.style.doubleHeight = n !== 0;
            }
            break;

          case ESC_COMMANDS.PICA: // ESC P
            this.state.font.cpi = 10;
            break;

          case ESC_COMMANDS.ELITE: // ESC M
            this.state.font.cpi = 12;
            break;

          case ESC_COMMANDS.MICRON: // ESC g
            this.state.font.cpi = 15;
            break;

          case ESC_COMMANDS.PROPORTIONAL: // ESC p n
            if (i < data.length) {
              const n = data[i++] ?? 0;
              this.state.font.style.proportional = n !== 0;
            }
            break;

          case ESC_COMMANDS.ABSOLUTE_HORZ_POS: // ESC $ nL nH
            if (i + 1 < data.length) {
              const nL = data[i++] ?? 0;
              const nH = data[i++] ?? 0;
              const pos = nL + nH * 256;
              // Position is absolute from page origin (0,0)
              // Units are 1/60 inch, convert to 360 DPI dots
              this.state.x = pos * 6;
            }
            break;

          case ESC_COMMANDS.ADVANCE_VERTICAL: // ESC J n
            if (i < data.length) {
              const n = data[i++] ?? 0;
              this.state.y += Math.round((n / 180) * 360);
            }
            break;

          case ESC_COMMANDS.BIT_IMAGE: // ESC * m nL nH data
            if (i + 2 < data.length) {
              const mode = data[i++] as BitImageMode;
              const nL = data[i++] ?? 0;
              const nH = data[i++] ?? 0;
              const width = nL + nH * 256;
              const modeInfo = GRAPHICS_MODES[mode];
              if (modeInfo) {
                const dataLen = width * modeInfo.bytesPerColumn;
                if (i + dataLen <= data.length) {
                  const graphicsData = data.slice(i, i + dataLen);
                  this.renderGraphics(mode, width, graphicsData);
                  i += dataLen;
                }
              }
            }
            break;

          default:
            // Unknown command, skip
            break;
        }
      } else if (byte === ASCII.CR) {
        this.carriageReturn();
        i++;
      } else if (byte === ASCII.LF) {
        this.lineFeed();
        i++;
      } else if (byte === ASCII.FF) {
        this.formFeed();
        i++;
      } else if (byte >= 32 && byte < 127) {
        // Printable ASCII
        const width = this.drawChar(byte, this.state.x, this.state.y);
        this.state.x += width;
        i++;
      } else if (byte >= 0xb3 && byte <= 0xda) {
        // CP437 box-drawing characters
        const width = this.drawChar(byte, this.state.x, this.state.y);
        this.state.x += width;
        i++;
      } else {
        // Skip other control characters
        i++;
      }
    }
  }

  /**
   * Get all rendered pages
   */
  getPages(): VirtualPage[] {
    // Include current page if it has content
    const result = [...this.pages];
    if (this.currentPage && this.state.y > this.state.paper.margins.top) {
      result.push(this.currentPage);
    }
    return result;
  }

  /**
   * Get single page (for simple documents)
   */
  getPage(index = 0): VirtualPage | null {
    const pages = this.getPages();
    return pages[index] ?? null;
  }

  /**
   * Reset renderer to initial state
   */
  reset(): void {
    this.pages = [];
    this.state = createInitialState(this.state.paper);
    this.initNewPage();
  }
}

export default VirtualRenderer;
